<div class="p-4 bg-white min-vh-100">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-black fw-bold mb-0">
      <i nz-icon nzType="project" class="text-primary me-2"></i> 
      {{ 'TaskManagement::Menu:Projects' | abpLocalization }}
    </h3>
    
    <div class="d-flex gap-3 align-items-center">
      <nz-input-group [nzPrefix]="prefixIconSearch" [nzSuffix]="sortIcon" style="width: 350px">
        <input type="text" nz-input [(ngModel)]="filterText" (input)="loadProjects()" 
               [placeholder]="'TaskManagement::ProjectName' | abpLocalization" />
      </nz-input-group>
      
      <ng-template #prefixIconSearch><i nz-icon nzType="search"></i></ng-template>
      
      <ng-template #sortIcon>
        <i nz-icon [nzType]="isCreationSortDesc ? 'sort-descending' : 'sort-ascending'" 
           class="text-primary cursor-pointer"
           (click)="toggleCreationSort()"
           nz-tooltip [nzTooltipTitle]="isCreationSortDesc ? ('TaskManagement::SortNewest' | abpLocalization) : ('TaskManagement::SortOldest' | abpLocalization)">
        </i>
      </ng-template>

      <button *ngIf="permission.getGrantedPolicy('TaskManagement.Projects.Create')" 
              nz-button nzType="primary" (click)="createProject()" class="rounded-pill px-4 shadow-sm">
        <i nz-icon nzType="plus"></i> {{ 'TaskManagement::NewProject' | abpLocalization }}
      </button>
    </div>
  </div>

  <nz-spin [nzSpinning]="loading">
    <div class="row g-4">
      <div class="col-md-4" *ngFor="let item of projectData.items">
        <nz-card class="project-card border shadow-sm rounded-16 overflow-hidden position-relative" 
                 (click)="openTasks(item.id)" 
                 [nzBodyStyle]="{ padding: '20px' }">
          
          <div class="mb-2">
            <h5 class="text-black fw-bold mb-1">{{ item.name }}</h5>
            <p class="text-muted small text-truncate mb-3">{{ item.description || ('TaskManagement::NoDescription' | abpLocalization) }}</p>
          </div>
          
          <div class="progress-section mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-black x-small fw-bold">{{ 'TaskManagement::Progress' | abpLocalization }}</span>
              <span class="text-primary fw-bold small">{{ item.progress | number:'1.0-0' }}%</span>
            </div>
            <nz-progress [nzPercent]="item.progress" [nzShowInfo]="false" nzStatus="active" [nzStrokeWidth]="8" [nzStrokeColor]="'#1890ff'"></nz-progress>
          </div>

          <hr class="my-3 opacity-25">

          <div class="d-flex justify-content-between align-items-center mt-auto">
            <div class="d-flex align-items-center">
              <nz-avatar nzSize="small" [nzText]="item.projectManagerName?.[0]" class="bg-primary me-2"></nz-avatar>
              <div class="d-flex flex-column">
                <span class="text-black x-small fw-bold">{{ item.projectManagerName }}</span>
                <span class="text-muted x-small" style="font-size: 0.6rem !important;">{{ item.creationTime | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>

            <div class="project-footer-actions d-flex gap-1">
              <button nz-button nzType="text" nzShape="circle" (click)="editProject($event, item)" nz-tooltip [nzTooltipTitle]="'TaskManagement::Edit' | abpLocalization">
                <i nz-icon nzType="edit" class="text-primary fs-5"></i>
              </button>
              <button *ngIf="permission.getGrantedPolicy('TaskManagement.Projects.Delete')" 
                      nz-button nzType="text" nzShape="circle" (click)="deleteProject($event, item.id)" nz-tooltip [nzTooltipTitle]="'TaskManagement::Delete' | abpLocalization">
                <i nz-icon nzType="delete" class="text-danger fs-5"></i>
              </button>
            </div>
          </div>
        </nz-card>
      </div>
    </div>
  </nz-spin>
</div>

<nz-drawer [nzVisible]="isModalOpen" [nzTitle]="drawerTitle" [nzWidth]="450" nzPlacement="right" 
           (nzOnClose)="handleCancel()" [nzFooter]="drawerFooter">
  <ng-template #drawerTitle>
    <span class="fw-bold text-black"><i nz-icon nzType="form" class="text-primary me-2"></i> 
      {{ (isEditMode ? ('TaskManagement::Update' | abpLocalization) : ('TaskManagement::Create' | abpLocalization)) }}
    </span>
  </ng-template>

  <ng-container *nzDrawerContent>
    <form nz-form [formGroup]="form" nzLayout="vertical">
      <nz-form-item class="mb-3">
        <nz-form-label nzRequired>{{ 'TaskManagement::ProjectName' | abpLocalization }}</nz-form-label>
        <nz-form-control><input nz-input formControlName="name" class="rounded-8" /></nz-form-control>
      </nz-form-item>
      
      <nz-form-item class="mb-3">
        <nz-form-label>{{ 'TaskManagement::Description' | abpLocalization }}</nz-form-label>
        <nz-form-control><textarea nz-input formControlName="description" rows="4" class="rounded-8"></textarea></nz-form-control>
      </nz-form-item>

      <nz-form-item class="mb-3">
        <nz-form-label nzRequired>{{ 'TaskManagement::ProjectManager' | abpLocalization }}</nz-form-label>
        <nz-form-control>
          <nz-select formControlName="projectManagerId" nzShowSearch [nzPlaceHolder]="'TaskManagement::SelectManager' | abpLocalization" class="w-100">
            <nz-option *ngFor="let u of projectManagers" [nzLabel]="u.userName" [nzValue]="u.id"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="mb-3">
        <nz-form-label>{{ 'TaskManagement::Members' | abpLocalization }}</nz-form-label>
        <nz-form-control>
          <nz-select formControlName="memberIds" nzMode="multiple" nzShowSearch [nzPlaceHolder]="'TaskManagement::SelectUser' | abpLocalization" class="w-100">
            <nz-option *ngFor="let u of users" [nzLabel]="u.userName" [nzValue]="u.id"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>

  <ng-template #drawerFooter>
    <div class="text-end py-2">
      <button nz-button (click)="handleCancel()" class="me-2 rounded-pill px-4">{{ 'TaskManagement::Cancel' | abpLocalization }}</button>
      <button nz-button nzType="primary" (click)="save()" [nzLoading]="saving" class="rounded-pill px-4 shadow-sm">
        {{ 'TaskManagement::Save' | abpLocalization }}
      </button>
    </div>
  </ng-template>
</nz-drawer>
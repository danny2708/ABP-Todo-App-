<div class="task-manager-container p-3 bg-white min-vh-100">
  <div class="row g-3 mb-3">
    <div class="col-md-3" *ngFor="let stat of [
      {label: 'TỔNG CÔNG VIỆC', count: taskData.totalCount, color: 'text-primary', icon: 'fa-tasks', bg: 'bg-soft-primary'}, 
      {label: 'ĐANG XỬ LÝ', count: inProgressCount, color: 'text-warning', icon: 'fa-spinner', bg: 'bg-soft-warning'}, 
      {label: 'HOÀN THÀNH', count: completedCount, color: 'text-success', icon: 'fa-check-double', bg: 'bg-soft-success'}
    ]">
      <div class="stat-card py-2 px-3 border shadow-none">
        <div class="stat-icon" [class]="stat.bg"><i class="fas" [class]="stat.icon"></i></div>
        <div class="stat-content">
          <span class="text-black small fw-bold text-uppercase">{{ stat.label }}</span>
          <h4 class="mb-0 fw-bold" [class]="stat.color">{{ stat.count }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card py-2 px-3 border border-danger shadow-none bg-soft-danger cursor-pointer" (click)="isOverdueModalOpen = true">
        <div class="stat-icon bg-danger text-white"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-content">
          <span class="text-danger small fw-bold text-uppercase">QUÁ HẠN</span>
          <h4 class="mb-0 fw-bold text-danger">{{ overdueTasks.length }}</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="card tasks-card border shadow-none">
    <div class="card-header border-0 bg-white py-2 px-3">
      <div class="row align-items-center">
        <div class="col-md-4">
          <h5 class="mb-0 text-black fw-bold">
            <i class="fas fa-clipboard-list me-2 text-primary"></i> Danh sách công việc
          </h5>
        </div>
        <div class="col-md-5">
          <nz-input-group [nzPrefix]="prefixIconSearch" class="search-compact">
            <input type="text" nz-input [(ngModel)]="filterText" (input)="onSearch()" placeholder="Tìm kiếm công việc..." />
          </nz-input-group>
          <ng-template #prefixIconSearch><i nz-icon nzType="search" class="text-muted"></i></ng-template>
        </div>
        <div class="col-md-3 text-end">
          <button nz-button nzType="primary" (click)="createTask()" class="rounded-pill px-3 shadow-none">
            <i nz-icon nzType="plus"></i> {{ (hasCreatePermission ? 'Công việc mới' : 'Gửi đề xuất') }}
          </button>
        </div>
      </div>
    </div>

    <div class="card-body px-3 py-2">
      <div class="row g-2 mb-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label text-black fw-bold small mb-1">Trạng thái</label>
          <nz-select [(ngModel)]="filterStatus" nzAllowClear nzPlaceHolder="Lọc trạng thái" (ngModelChange)="onFilterChange()" class="w-100">
            <nz-option nzLabel="Mới" [nzValue]="taskStatus.New"></nz-option>
            <nz-option nzLabel="Đang xử lý" [nzValue]="taskStatus.InProgress"></nz-option>
            <nz-option nzLabel="Hoàn thành" [nzValue]="taskStatus.Completed"></nz-option>
          </nz-select>
        </div>
        <div class="col-md-4">
          <label class="form-label text-black fw-bold small mb-1">Người thực hiện</label>
          <nz-select [(ngModel)]="filterAssignedUserId" nzAllowClear nzShowSearch nzPlaceHolder="Lọc người dùng" (ngModelChange)="onFilterChange()" class="w-100">
            <nz-option *ngFor="let user of users" [nzLabel]="user.userName" [nzValue]="user.id"></nz-option>
          </nz-select>
        </div>
        <div class="col-md-2">
          <button nz-button nzType="text" (click)="clearFilters()" class="text-black fw-bold small mt-4">
            <i nz-icon nzType="close-circle"></i> Mặc định
          </button>
        </div>
      </div>

      <nz-table #tasksTable class="modern-table" [nzData]="taskData.items" [nzTotal]="taskData.totalCount" [nzLoading]="loading" 
                [nzFrontPagination]="false" [nzShowPagination]="true" [nzPageSize]="pageSize" [nzPageIndex]="pageIndex" 
                (nzPageIndexChange)="onPageChange($event)" nzSize="small">
        <thead>
          <tr>
            <th class="text-black fw-bold" nzShowSort nzColumnKey="title" (nzSortOrderChange)="onSortChange($event)">
              Tiêu đề
              <span class="ms-2 creation-sort-btn" (click)="toggleCreationSort($event)" 
                    nz-tooltip [nzTooltipTitle]="'Sắp xếp theo thời gian: ' + (isCreationSortDesc ? 'Mới nhất' : 'Cũ nhất')">
                <i nz-icon [nzType]="isCreationSortDesc ? 'sort-descending' : 'sort-ascending'" 
                   [class.text-primary]="sorting.includes('CreationTime')"></i>
              </span>
            </th>
            <th class="text-black fw-bold" nzShowSort nzColumnKey="status" (nzSortOrderChange)="onSortChange($event)">Trạng thái</th>
            <th class="text-black fw-bold" nzShowSort nzColumnKey="assignedUserId" (nzSortOrderChange)="onSortChange($event)">Người thực hiện</th>
            <th class="text-black fw-bold" nzShowSort nzColumnKey="dueDate" (nzSortOrderChange)="onSortChange($event)">Hạn chót</th>
            <th class="text-end text-black fw-bold">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let task of tasksTable.data" class="task-row">
            <td>
              <div class="d-flex flex-column">
                <span class="text-black fw-bold mb-0">
                  {{ task.title }}
                  <nz-tag *ngIf="!task.isApproved" nzColor="error" class="ms-2 x-small">ĐỀ XUẤT</nz-tag>
                </span>
                <small class="text-dark opacity-75 text-truncate" style="max-width: 200px;">{{ task.description }}</small>
              </div>
            </td>
            <td>
              <nz-tag [nzColor]="getStatusColor(task.status)" class="rounded-pill border-0 fw-bold">{{ ('TaskManagement::' + getStatusKey(task.status)) | abpLocalization }}</nz-tag>
            </td>
            <td>
              <div class="d-flex align-items-center" *ngIf="task.assignedUserName; else unassignedTpl">
                <nz-avatar nzSize="small" [nzText]="task.assignedUserName[0]" class="bg-primary me-2"></nz-avatar>
                <span class="text-black fw-medium small">{{ task.assignedUserName }}</span>
              </div>
              <ng-template #unassignedTpl>
                <span class="text-muted small fst-italic">
                  <i class="fas fa-user-slash me-1"></i> {{ 'TaskManagement::Unassigned' | abpLocalization }}
                </span>
              </ng-template>
            </td>
            <td>
              <span class="small fw-bold" [class.text-danger]="isOverdue(task.dueDate)">
                {{ task.dueDate | date:'dd/MM/yyyy HH:mm' }}
              </span>
            </td>
            <td class="text-end">
              <div class="row-actions">
                <button *ngIf="!task.isApproved && hasApprovePermission" nz-button nzType="text" (click)="approveTask(task.id)" nz-tooltip nzTooltipTitle="Phê duyệt">
                  <i nz-icon nzType="check-circle" class="text-success fs-5"></i>
                </button>
                <button nz-button nzType="text" (click)="editTask(task)"><i nz-icon nzType="edit" class="text-primary fs-5"></i></button>
                <button *ngIf="hasDeletePermission || (task.status === taskStatus.New && task.creatorId === currentUser.id)" nz-button nzType="text" nz-popconfirm nzPopconfirmTitle="Xóa?" (nzOnConfirm)="delete(task.id)">
                  <i nz-icon nzType="delete" class="text-danger fs-5"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
  </div>
</div>

<nz-drawer [(nzVisible)]="isModalOpen" [nzTitle]="drawerTitle" [nzWidth]="400" nzPlacement="right" (nzOnClose)="handleCancel()" [nzFooter]="drawerFooter">
  <ng-template #drawerTitle>
    <span class="fw-bold text-black"><i nz-icon nzType="form" class="text-primary me-2"></i> {{ isEditMode ? 'Cập nhật' : 'Tạo mới' }} công việc</span>
  </ng-template>
  <ng-container *nzDrawerContent>
    <form nz-form [formGroup]="form" nzLayout="vertical">
      <nz-form-item class="mb-2">
        <nz-form-label nzRequired class="text-black fw-bold">Tiêu đề</nz-form-label>
        <nz-form-control><input nz-input formControlName="title" placeholder="Tiêu đề..." /></nz-form-control>
      </nz-form-item>
      <nz-form-item class="mb-2">
        <nz-form-label class="text-black fw-bold">Mô tả</nz-form-label>
        <nz-form-control><textarea nz-input formControlName="description" rows="3" placeholder="Mô tả..."></textarea></nz-form-control>
      </nz-form-item>
      <nz-form-item class="mb-2">
        <nz-form-label nzRequired class="text-black fw-bold">Trạng thái</nz-form-label>
        <nz-form-control>
          <nz-select formControlName="status" class="w-100">
            <nz-option nzLabel="Mới" [nzValue]="taskStatus.New"></nz-option>
            <nz-option nzLabel="Đang xử lý" [nzValue]="taskStatus.InProgress"></nz-option>
            <nz-option nzLabel="Hoàn thành" [nzValue]="taskStatus.Completed"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item class="mb-2">
        <nz-form-label class="text-black fw-bold">Người nhận việc</nz-form-label>
        <nz-form-control>
          <nz-select formControlName="assignedUserId" nzAllowClear nzShowSearch class="w-100">
            <nz-option *ngFor="let user of users" [nzLabel]="user.userName" [nzValue]="user.id"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item class="mb-2">
        <nz-form-label class="text-black fw-bold">Hạn chót</nz-form-label>
        <nz-form-control>
          <nz-date-picker formControlName="dueDate" nzShowTime nzFormat="yyyy-MM-dd HH:mm" class="w-100"></nz-date-picker>
        </nz-control>
      </nz-form-item>
    </form>
  </ng-container>
  <ng-template #drawerFooter>
    <div class="text-end">
      <button nz-button nzType="default" (click)="handleCancel()" class="me-2 rounded-pill">Hủy</button>
      <button nz-button nzType="primary" (click)="save()" [disabled]="form.invalid || form.disabled" [nzLoading]="saving" class="rounded-pill">Lưu lại</button>
    </div>
  </ng-template>
</nz-drawer>

<nz-modal [(nzVisible)]="isOverdueModalOpen" nzTitle="Danh sách công việc quá hạn" (nzOnCancel)="isOverdueModalOpen = false" [nzFooter]="null" nzWidth="700px">
  <ng-container *nzModalContent>
    <nz-table #overdueTable [nzData]="overdueTasks" nzSize="small" [nzFrontPagination]="true">
      <thead>
        <tr>
          <th>Tiêu đề</th>
          <th>Người thực hiện</th>
          <th>Hạn chót</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of overdueTable.data">
          <td class="text-danger fw-bold">{{ task.title }}</td>
          <td>{{ task.assignedUserName || 'Chưa chỉ định' }}</td>
          <td class="text-danger">{{ task.dueDate | date:'dd/MM/yyyy HH:mm' }}</td>
        </tr>
      </tbody>
    </nz-table>
  </ng-container>
</nz-modal>